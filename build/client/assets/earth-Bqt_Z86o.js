import{r as e,j as E}from"./jsx-runtime-56mEcsVX.js";import{O as Pe,H as ze,m as Me,a as Ne,b as Fe,c as qe,d as Oe,e as De,f as Ve,g as He}from"./milkyway-C30K_w18.js";import{u as Ye,e as Ce,m as We,a as Le,T as Xe,b as Ze,L as Ge,t as Be}from"./heading-Cj-hZXXx.js";import{S as Ie}from"./meta--FhERGoB.js";import{a as Je}from"./image-CS9sYp9c.js";import{u as Ue}from"./useWindowSize-le6giuVV.js";import{V as ue,W as $e,S as Ee,A as Ke,P as Qe,a as et,C as tt,R as nt,b as rt,D as st,r as ct,c as at,d as ot,g as le,e as it,f as ut,h as lt,L as dt,t as ft,E as mt,i as pt,m as ht,j as gt}from"./three-GdnwbQ7K.js";import{c as ke}from"./clamp-e7DugykH.js";import{t as bt}from"./throttle-BgiUmwhn.js";import{u as T}from"./use-spring-CMGJKb8F.js";import"./components-lSBiwjrf.js";import"./config-DzEhh7_D.js";import"./index-Dgl7HRYi.js";const wt="_earth_4tqjk_1",xt="_loader_4tqjk_15",vt="_viewport_4tqjk_43",St="_canvas_4tqjk_65",yt="_labels_4tqjk_103",Ct="_label_4tqjk_103",Et="_vignette_4tqjk_163",kt="_sections_4tqjk_187",Rt="_section_4tqjk_187",k={earth:wt,loader:xt,viewport:vt,canvas:St,labels:yt,label:Ct,vignette:Et,sections:kt,section:Rt},he={x:0,y:0,z:2},de=(n,u,h)=>n+h*(u-n),Re=n=>Object.keys(n).map(u=>parseFloat(Math.round(n[u]*100)/100).toFixed(2)).join(", "),fe=n=>!n||!n.camera?he:{x:n.camera[0],y:n.camera[1],z:n.camera[2]},Lt=(n,u)=>{const h=(P=0)=>Math.round((P+Number.EPSILON)*100)/100;return h(n==null?void 0:n.x)===h(u==null?void 0:u.x)&&h(n==null?void 0:n.y)===h(u==null?void 0:u.y)&&h(n==null?void 0:n.z)===h(u==null?void 0:u.z)},me={stiffness:80,damping:40,mass:2,restSpeed:.001,restDelta:.001},pe={stiffness:40,damping:30,mass:2,restSpeed:.001,restDelta:.001},jt={stiffness:40,damping:30},je=e.createContext({}),Yt=({position:n=[0,0,0],scale:u=1,hideMeshes:h=[],labels:P=[],className:X,children:Z})=>{const[m,G]=e.useState(!1),[z,F]=e.useState(!1),[B,Q]=e.useState(!1),[I,_e]=e.useState(!1),g=e.useRef([]),ee=e.useRef(),te=e.useRef(),q=e.useRef(),_=e.useRef(),S=e.useRef(),o=e.useRef(),ge=e.useRef(),be=e.useRef(),ne=e.useRef(),p=e.useRef(),J=e.useRef(),O=e.useRef(),M=Je(q),U=e.useRef(),re=e.useRef(fe(g.current[0])),$=e.useRef([]),y=e.useRef(),se=e.useRef(),we=e.useRef(),ce=e.useRef(),{width:D,height:ae}=Ue(),K=Ye(),R=T(0,me),L=T(0,me),j=T(0,me),V=T(0,pe),H=T(0,pe),Y=T(0,pe),N=T(0,jt),oe=e.useCallback(()=>{if(!M){cancelAnimationFrame(U.current);return}U.current=requestAnimationFrame(oe);const r=ge.current.getDelta();O.current.update(r),y.current.update(),S.current.render(_.current,o.current),$.current.forEach(c=>{const{element:i,position:b,sprite:x}=c,d=new ue(...b),a=o.current.position.distanceTo(p.current.position),f=o.current.position.distanceTo(x.position)>a;d.project(o.current),d.x=Math.round((.5+d.x/2)*window.innerWidth),d.y=Math.round((.5-d.y/2)*window.innerHeight),i.style.setProperty("--posX",Ce(d.x)),i.style.setProperty("--posY",Ce(d.y)),f?i.dataset.occluded=!0:i.dataset.occluded=!1})},[M]);e.useEffect(()=>{ce.current=!0;const{innerWidth:r,innerHeight:c}=window;S.current=new $e({canvas:q.current,antialias:!1,alpha:!0,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0}),S.current.setPixelRatio(1),S.current.outputColorSpace=Ee,S.current.toneMapping=Ke,o.current=new Qe(54,r/c,.1,100),o.current.position.x=re.current.x,o.current.position.y=re.current.y,o.current.position.z=re.current.z,o.current.lookAt(0,0,0),R.set(o.current.position.x,!1),L.set(o.current.position.y,!1),j.set(o.current.position.z,!1),_.current=new et,ge.current=new tt,ne.current=new nt;const i=new rt(2236962,.05),b=new st(16777215,1.5);b.position.set(3,0,1);const x=[i,b];return x.forEach(d=>_.current.add(d)),y.current=new Pe(o.current,q.current),y.current.enableZoom=!1,y.current.enablePan=!1,y.current.enableDamping=!1,y.current.rotateSpeed=.5,()=>{ce.current=!1,cancelAnimationFrame(U.current),ct(x),at(_.current),ot(S.current)}},[]),e.useEffect(()=>{const r=()=>{F(!0),R.stop(),L.stop(),j.stop()},c=()=>{R.set(o.current.position.x,!1),L.set(o.current.position.y,!1),j.set(o.current.position.z,!1),F(!1)};return y.current.addEventListener("start",r),y.current.addEventListener("end",c),()=>{y.current.removeEventListener("start",r),y.current.removeEventListener("end",c)}},[R,L,j]),e.useEffect(()=>{if(!m)return;const r=le("Chunk",p.current),c=le("Atmosphere",p.current),i=(t,l)=>{o.current.position[t]=l},b=R.on("change",t=>i("x",t)),x=L.on("change",t=>i("y",t)),d=j.on("change",t=>i("z",t)),a=(t,l)=>{r.position[t]=l},A=V.on("change",t=>a("x",t)),f=H.on("change",t=>a("y",t)),w=Y.on("change",t=>a("z",t)),s=N.on("change",t=>{c.material.opacity=t});return()=>{b(),x(),d(),A(),f(),w(),s()}},[R,L,j,V,H,Y,m,N]),e.useEffect(()=>{D<=We.tablet&&(y.current.enabled=!1)},[D]),e.useEffect(()=>{if(m)return;const r=new ze,c=new it(S.current);c.compileCubemapShader();const i=async()=>{const a=await ht.loadAsync(He);p.current=a.scene,J.current=a.animations,O.current=new gt(p.current),O.current.timeScale=.1,p.current.traverse(async A=>{const{material:f,name:w}=A;w==="Atmosphere"&&(f.alphaMap=f.map),f&&await S.current.initTexture(f)}),p.current.position.x=n[0],p.current.position.y=n[1],p.current.position.z=n[2],p.current.scale.x=u,p.current.scale.y=u,p.current.scale.z=u},b=async()=>{const a=await r.loadAsync([Ne,Fe,qe,Oe,De,Ve]);a.magFilter=pt,se.current=c.fromCubemap(a),c.dispose(),await S.current.initTexture(se.current.texture)},x=async()=>{const a=await ft.loadAsync(Me);a.mapping=mt,a.colorSpace=Ee,_.current.background=a,await S.current.initTexture(a)},d=async()=>{await Promise.all([x(),b(),i()]),p.current.traverse(({material:a})=>{a&&(a.envMap=se.current.texture,a.needsUpdate=!0)}),ce.current&&G(!0)};e.startTransition(()=>{d(),setTimeout(()=>{_e(!0)},1e3)})},[m,n,u]),e.useEffect(()=>(m&&!we.current&&(_.current.add(p.current),we.current=!0),m&&M&&(Q(!0),oe()),()=>{cancelAnimationFrame(U.current)}),[oe,M,m]),e.useEffect(()=>{m&&(te.current.innerHTML="",$.current=P.map(r=>{const c=document.createElement("div");c.classList.add(k.label),c.dataset.hidden=!0,c.style.setProperty("--delay",`${r.delay||0}ms`),c.textContent=r.text,te.current.appendChild(c);const i=new ut;return i.position.set(...r.position),i.scale.set(60,60,1),{element:c,...r,sprite:i}}))},[P,m]),e.useEffect(()=>{S.current.setSize(D,ae),o.current.aspect=D/ae,o.current.updateProjectionMatrix()},[D,ae]),e.useEffect(()=>{const r=q.current,c=i=>{const{innerWidth:b,innerHeight:x}=window,d=Re(o.current.position);console.info({cameraPosition:d}),be.current=new lt(i.clientX/b*2-1,-(i.clientY/x)*2+1),ne.current.setFromCamera(be.current,o.current);const a=ne.current.intersectObjects(_.current.children,!0);if(a.length>0){const A=Re(a[0].point);console.info({clickPosition:A})}};return()=>{r.removeEventListener("click",c)}},[]);const xe=e.useCallback(()=>{if(!ee.current)return;const{offsetTop:r}=ee.current,{innerHeight:c}=window,i=window.scrollY-r;let b;const x=f=>{const w=g.current[f].meshes;p.current.traverse(s=>{const{name:t}=s,l=le("Chunk",p.current),v=w==null?void 0:w.includes(t),W=h==null?void 0:h.includes(t);if(v)if(t==="Atmosphere")s.visible=!0,N.set(1);else if(t==="Chunk"){const C=new ue(-.4,.4,.4);s.visible=!0,K?s.position.set(...C.toArray()):(V.set(C.x),H.set(C.y),Y.set(C.z))}else t==="EarthFull"&&l.visible?s.visible=!1:s.visible=!0;else if(W&&!v)if(t==="Atmosphere")N.set(0);else if(t==="Chunk"){const C=new ue(0,0,0);Lt(C,l.position)&&(s.visible=!1),V.set(C.x),H.set(C.y),Y.set(C.z)}else t==="EarthPartial"&&l.visible?s.visible=!0:s.visible=!1})},d=f=>{const w=g.current[f].animations;K||(J.current.forEach((s,t)=>{w.find(l=>l.includes(t.toString()))||O.current.clipAction(s).reset().stop()}),J.current.length&&g.current[f].animations&&w.forEach(s=>{const t=s.split(":"),l=J.current[Number(t[0])],v=O.current.clipAction(l);(!t[1]||t[1]!=="loop")&&(v.clampWhenFinished=!0,v.loop=dt),v.play()}))},a=f=>{$.current.forEach(s=>{s.hidden&&(s.element.dataset.hidden=!0,s.element.setAttribute("aria-hidden",!0))}),g.current[f].labels.forEach(s=>{$.current.filter(l=>l.text===s).forEach(l=>{l.element.dataset.hidden=!1,l.element.setAttribute("aria-hidden",!1)})})};requestAnimationFrame(()=>{const f=g.current.length-1,w=Math.floor(i/c),s=ke(w,0,f),t=g.current[s],l=g.current[s+1],v=fe(t)||he,W=fe(l)||he,C=(i-c*s)/c,ie=ke(C,0,1),ve=de(v.x,W.x,ie),Se=de(v.y,W.y,ie),ye=de(v.z,W.z,ie);if(b!==v&&g.current.length&&t&&(x(s),d(s),a(s)),b=v,!z){if(K){o.current.position.set(ve,Se,ye);return}R.set(ve),L.set(Se),j.set(ye)}})},[R,L,j,V,H,Y,z,h,N,K]);e.useEffect(()=>{const r=bt(xe,100);return m&&M&&window.addEventListener("scroll",r),()=>{window.removeEventListener("scroll",r)}},[xe,M,m,N]);const Ae=e.useCallback(r=>{g.current=[...g.current,r]},[]),Te=e.useCallback(r=>{g.current=g.current.filter(c=>c!==r)},[]);return E.jsx(je.Provider,{value:{registerSection:Ae,unregisterSection:Te},children:E.jsxs("div",{className:Le(k.earth,X),ref:ee,children:[E.jsxs("div",{className:k.viewport,children:[E.jsx("canvas",{className:k.canvas,"data-visible":m&&B,"data-grabbing":z,ref:q}),E.jsx("div",{className:k.labels,"aria-live":"polite",ref:te}),E.jsx("div",{className:k.vignette})]}),E.jsx("div",{className:k.sections,children:Z}),E.jsx(Xe,{unmount:!0,in:!m&&I,timeout:Ze(Be.base.durationL),children:r=>E.jsx(Ie,{className:k.loader,"data-visible":r,children:E.jsx(Ge,{})})})]})})},Wt=e.memo(({children:n,scrim:u,scrimReverse:h,className:P,camera:X=[0,0,0],animations:Z=[],meshes:m=[],labels:G=[]})=>{const{registerSection:z,unregisterSection:F}=e.useContext(je),B=e.useRef(),Q=JSON.stringify(Z)+JSON.stringify(X)+JSON.stringify(G)+JSON.stringify(m);return e.useEffect(()=>{const I={camera:X,animations:Z,meshes:m,labels:G,sectionRef:B};return z(I),()=>{F(I)}},[Q,z,F]),E.jsx("div",{className:Le(k.section,P),"data-scrim":u,"data-scrim-reverse":h,ref:B,children:n})});export{Yt as Earth,Wt as EarthSection};
